<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>SSB 1.0 - Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="sidebar" id="left-sidebar">
    <h2>SSB 1.0</h2>
    <ul id="main-nav">
      <!-- Qu·∫£n l√Ω -->
  <!-- === QU·∫¢N L√ù === -->
  <li class="manager-only" data-page="m-dashboard">üìä <span>T·ªïng quan h·ªá th·ªëng</span></li>
  <li class="manager-only" data-page="m-schedules">üóìÔ∏è <span>L·ªãch tr√¨nh xe</span></li>
  <li class="manager-only" data-page="m-routes">üß≠ <span>Ph√¢n c√¥ng t√†i x·∫ø & xe bu√Ωt</span></li>
  <li class="manager-only" data-page="m-tracking">üìç <span>Theo d√µi v·ªã tr√≠ xe</span></li>
  <li class="manager-only" data-page="m-messages">üí¨ <span>Tin nh·∫Øn</span></li>

  <!-- === T√ÄI X·∫æ === -->
  <li class="driver-only" data-page="d-schedules">üìÖ <span>L·ªãch l√†m vi·ªác</span></li>
  <li class="driver-only" data-page="d-users">üë®‚Äçüéì <span>Danh s√°ch h·ªçc sinh</span></li>
  <li class="driver-only" data-page="d-reports">‚úÖ <span>B√°o c√°o ƒë√≥n / tr·∫£</span></li>
  <li class="driver-only" data-page="d-messages">‚ö†Ô∏è <span>C·∫£nh b√°o s·ª± c·ªë</span></li>

  <!-- === PH·ª§ HUYNH === -->
  <li class="parent-only" data-page="p-tracking">üöå <span>Theo d√µi xe c·ªßa con</span></li>
  <li class="parent-only" data-page="p-messages">üîî <span>Xe ƒë·∫øn g·∫ßn</span></li>
  <li class="parent-only" data-page="p-reports">üö® <span>Tr·ªÖ chuy·∫øn</span></li>
    </ul>
    <button class="logout-btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
  </div>

  <div class="main-content" id="main-content-area">
    <!-- N·ªôi dung ch√≠nh s·∫Ω ch·ª©a to√†n b·ªô views (dashboard, schedules, routes, users, tracking, messages, reports) -->
    <!-- Copy giao di·ªán t·ª´ b·∫£n demo v√†o ƒë√¢y -->
    <div class="app" id="app">
      <main class="main">
        <div class="container">
          <div class="mobile-top">
            <button class="open-sb" id="open-sb">‚ò∞ Menu</button>
            <div style="font-weight:700">SSB 1.0</div>
            <div style="margin-left:auto;display:flex;gap:8px">
              <button class="btn ghost" id="btn-simulate">T·∫Øt m√¥ ph·ªèng</button>
              <button class="btn" id="btn-export">T·∫£i HTML</button>
            </div>
          </div>

          <header class="top">
            <h1 id="page-title">T·ªïng quan h·ªá th·ªëng</h1>
            <div class="controls">
              <div class="chip" id="role-indicator">Qu·∫£n l√Ω</div>
              <div class="chip" id="time-indicator">Real-time</div>
            </div>
          </header>

          <div class="grid">
            <section>
              <div class="card" id="page-content">
                <!-- Dashboard view -->
                <div id="m-dashboard-view">
                  <div style="display:flex;gap:12px;align-items:center">
                    <div style="flex:1">
                      <h3>S·ªë li·ªáu nhanh</h3>
                      <div style="display:flex;gap:10px;margin-top:8px">
                        <div style="flex:1;background:#f9fafb;padding:12px;border-radius:8px">
                          <div class="muted">T·ªïng s·ªë xe</div>
                          <div style="font-weight:700;font-size:20px" id="total-buses">0</div>
                        </div>
                        <div style="flex:1;background:#f9fafb;padding:12px;border-radius:8px">
                          <div class="muted">Xe ƒëang ho·∫°t ƒë·ªông</div>
                          <div style="font-weight:700;font-size:20px" id="running-buses">0</div>
                        </div>
                        <div style="flex:1;background:#f9fafb;padding:12px;border-radius:8px">
                          <div class="muted">Tin nh·∫Øn ch·ªù</div>
                          <div style="font-weight:700;font-size:20px" id="pending-msg">0</div>
                        </div>
                      </div>
                    </div>
                    <div style="width:260px">
                      <h3>L·ªçc nhanh</h3>
                      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
                        <select id="filter-route"><option value="all">-- Ch·ªçn tuy·∫øn --</option></select>
                        <select id="filter-status"><option value="all">-- Tr·∫°ng th√°i --</option><option value="running">ƒêang ch·∫°y</option><option value="stopped">D·ª´ng</option></select>
                        <button class="btn" id="btn-apply">√Åp d·ª•ng</button>
                      </div>
                    </div>
                  </div>

                  <hr style="margin:16px 0" />

                  <div style="display:flex;gap:12px">
                    <div style="flex:1">
                      <h3>Danh s√°ch xe (m√¥ ph·ªèng)</h3>
                      <div class="list" id="bus-list">
                        <!-- buses here -->
                      </div>
                    </div>
                    <aside style="width:360px">
                      <div class="card map">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                          <div><strong>Map (placeholder)</strong><div class="muted" style="font-size:12px">B·∫£n ƒë·ªì t·∫°m ‚Äî t√≠ch h·ª£p Google Maps/Mapbox khi backend s·∫µn s√†ng</div></div>
                          <div class="chip" id="realtime-chip">{ realtime }</div>
                        </div>
                        <div id="map-items" style="overflow:auto;flex:1;padding-top:6px"></div>
                      </div>

                      <div style="margin-top:12px" class="card">
                        <h3>Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h3>
                        <div class="muted" id="activity-log" style="max-height:120px;overflow:auto"></div>
                      </div>
                    </aside>
                  </div>

                </div>

                <!-- Schedules -->
                <div id="m-schedules-view" class="hidden">
                  <h3>L·ªãch tr√¨nh</h3>
                  <div class="muted">T·∫°o l·ªãch tu·∫ßn/th√°ng, ph√¢n c√¥ng t√†i x·∫ø & xe</div>
                  <div style="margin-top:12px;display:flex;gap:8px">
                    <div style="flex:2">
                      <table>
                        <thead><tr><th>T√™n</th><th>Lo·∫°i</th><th>Th·ªùi gian</th><th>H√†nh ƒë·ªông</th></tr></thead>
                        <tbody id="schedules-table">
                        </tbody>
                      </table>
                    </div>
                    <div style="width:320px">
                      <div class="card">
                        <h3>T·∫°o / C·∫≠p nh·∫≠t l·ªãch</h3>
                        <div style="display:flex;flex-direction:column;gap:8px">
                          <input placeholder="T√™n l·ªãch" id="sched-name" />
                          <select id="sched-frequency"><option>Tu·∫ßn</option><option>Th√°ng</option></select>
                          <select id="sched-route"></select>
                          <button class="btn" id="sched-save">L∆∞u</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Routes -->
                <div id="m-routes-view" class="hidden">
                  <h3>Tuy·∫øn & Xe</h3>
                  <div style="display:flex;gap:12px">
                    <div style="flex:1">
                      <table>
                        <thead><tr><th>ID</th><th>T√™n Tuy·∫øn</th><th>Xe</th><th>T√†i x·∫ø</th></tr></thead>
                        <tbody id="routes-table"></tbody>
                      </table>
                    </div>
                    <div style="width:320px">
                      <div class="card">
                        <h3>Th√™m tuy·∫øn</h3>
                        <input id="route-name" placeholder="T√™n tuy·∫øn" />
                        <textarea id="route-stops" placeholder="Danh s√°ch ƒëi·ªÉm d·ª´ng (ph√¢n b·ªüi d·∫•u ph·∫©y)"></textarea>
                        <button class="btn" id="add-route">Th√™m</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Users -->
                <div id="d-users-view" class="hidden">
                  <h3>H·ªçc sinh / T√†i x·∫ø</h3>
                  <div style="display:flex;gap:12px">
                    <div style="flex:1">
                      <table>
                        <thead><tr><th>Lo·∫°i</th><th>T√™n</th><th>Li√™n h·ªá</th><th>H√†nh ƒë·ªông</th></tr></thead>
                        <tbody id="users-table"></tbody>
                      </table>
                    </div>
                    <div style="width:320px">
                      <div class="card">
                        <h3>Th√™m t√†i x·∫ø</h3>
                        <input id="driver-name" placeholder="T√™n" />
                        <input id="driver-phone" placeholder="SƒêT" />
                        <button class="btn" id="add-driver">Th√™m</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Tracking -->
                <div id="m-tracking-view" class="hidden">
                  <h3>Theo d√µi th·ªùi gian th·ª±c</h3>
                  <div class="muted">B·∫£n ƒë·ªì hi·ªÉn th·ªã v·ªã tr√≠ ‚Äî m√¥ ph·ªèng b·∫±ng d·ªØ li·ªáu gi·∫£</div>
                  <div style="margin-top:12px" id="tracking-map" class="map"></div>
                </div>

                <!-- Messages -->
                <div id="m-messages-view" class="hidden">
                  <h3>Tin nh·∫Øn</h3>
                  <div style="display:flex;gap:12px">
                    <div style="flex:1">
                      <div class="card">
                        <div style="display:flex;gap:8px;align-items:center">
                          <input id="msg-to" placeholder="G·ª≠i t·ªõi (t√†i x·∫ø / ph·ª• huynh)" />
                          <button class="btn" id="send-msg">G·ª≠i</button>
                        </div>
                        <textarea id="msg-body" placeholder="N·ªôi dung tin nh·∫Øn" style="margin-top:8px"></textarea>
                      </div>
                    </div>
                    <div style="width:320px">
                      <div class="card">
                        <h3>H·ªôp th∆∞</h3>
                        <div id="inbox" style="max-height:240px;overflow:auto"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Reports -->
                <div id="d-reports-view" class="hidden">
                  <h3>B√°o c√°o</h3>
                  <div class="muted">Th·ªëng k√™ l·ªãch s·ª≠, t·∫ßn su·∫•t tr·ªÖ, b√°o c√°o s·ª± c·ªë</div>
                  <div style="margin-top:10px">
                    <table>
                      <thead><tr><th>Ng√†y</th><th>Lo·∫°i</th><th>Chi ti·∫øt</th></tr></thead>
                      <tbody id="reports-table"></tbody>
                    </table>
                  </div>
                </div>

              </div>
            </section>

            <aside>
              <div class="card">
                <h3>Quick actions</h3>
                <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
                  <button class="btn" id="action-assign">Ph√¢n c√¥ng t√†i x·∫ø</button>
                  <button class="btn ghost" id="action-create-sched">T·∫°o l·ªãch m·ªõi</button>
                  <button class="btn ghost" id="action-send-alert">G·ª≠i c·∫£nh b√°o</button>
                </div>
              </div>

              <div style="margin-top:12px" class="card">
                <h3>Th√¥ng tin nhanh</h3>
                <div class="muted">Phi√™n b·∫£n UI: demo</div>
                <div class="muted">Ng√¥n ng·ªØ: <span id="ui-lang">Ti·∫øng Vi·ªát</span></div>
              </div>

              <div style="margin-top:12px" class="card">
                <h3>G·ª£i √Ω</h3>
                <div class="muted">Frontend n√†y d√πng HTML/CSS/JS tƒ©nh. Backend s·∫Ω cung c·∫•p API cho realtime, auth v√† d·ªØ li·ªáu.</div>
              </div>
            </aside>

          </div>

        </div>
      </main>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    // === K·∫æT N·ªêI API + REALTIME ===
    let state = { buses: [], routes: [], inbox: [], activities: [] };
    let simRunning = true;

    // G·ªåI API TH·∫¨T T·ª™ SQL
    async function loadRealData() {
      try {
        const res = await fetch('http://localhost:3000/api/parents/list');
        const data = await res.json();
        if (data.success && data.data.length > 0) {
          state.buses = data.data.map((p, i) => ({
            id: 100 + i,
            plate: `29A-${100 + i}`,
            route: i % 2 === 0 ? 'Tuy·∫øn A' : 'Tuy·∫øn B',
            lat: 21.02 + Math.random() * 0.02,
            lon: 105.81 + Math.random() * 0.02,
            status: 'running',
            driver: p.name
          }));
          renderBuses();
          renderMapItems();
          updateStats();
        }
      } catch (err) {
        console.error('L·ªói k·∫øt n·ªëi API:', err);
        document.body.innerHTML += '<p style="color:red">Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server!</p>';
      }
    }

    function renderBuses() {
      const list = document.getElementById('bus-list');
      if (!list) return;
      list.innerHTML = state.buses.map(b => `
        <div class="bus">
          <div class="pin">${b.id}</div>
          <div style="flex:1">
            <div style="font-weight:700">${b.plate}</div>
            <div style="font-size:13px; color:#64748b">${b.route} ‚Ä¢ ${b.driver}</div>
          </div>
          <span class="status ${b.status}">${b.status === 'running' ? 'ƒêang ch·∫°y' : 'D·ª´ng'}</span>
        </div>
      `).join('');
    }

    function renderMapItems() {
      const el = document.getElementById('map-items');
      if (!el) return;
      el.innerHTML = state.buses.map(b => `
        <div class="bus">
          <div class="pin" style="width:32px;height:32px;">Bus</div>
          <div style="flex:1">
            <div style="font-weight:700">${b.plate}</div>
            <div style="font-size:12px; color:#64748b">
              ${b.route} ‚Ä¢ ${b.lat.toFixed(4)}, ${b.lon.toFixed(4)}
            </div>
          </div>
          <span class="status ${b.status}">${b.status === 'running' ? 'Ch·∫°y' : 'D·ª´ng'}</span>
        </div>
      `).join('');
    }

    function updateStats() {
      document.getElementById('total-buses').textContent = state.buses.length;
      document.getElementById('running-buses').textContent = state.buses.filter(b => b.status === 'running').length;
    }

    function tickSimulate() {
      if (!simRunning || state.buses.length === 0) return;
      state.buses.forEach(b => {
        if (Math.random() > 0.85) b.status = b.status === 'running' ? 'stopped' : 'running';
        if (b.status === 'running') {
          b.lat += (Math.random() - 0.5) * 0.001;
          b.lon += (Math.random() - 0.5) * 0.001;
        }
      });
      const b = state.buses[Math.floor(Math.random() * state.buses.length)];
      const act = `${new Date().toLocaleTimeString()} ‚Äî ${b.plate} (${b.route}) ${b.status === 'running' ? 'ƒëang ch·∫°y' : 'd·ª´ng l·∫°i'}`;
      state.activities.push(act);
      if (state.activities.length > 50) state.activities.shift();

      renderBuses(); renderMapItems(); updateStats();
      document.getElementById('activity-log').innerHTML = state.activities.slice().reverse().map(a =>
        `<div style="padding:6px; border-bottom:1px solid #f1f5f9;">${a}</div>`
      ).join('');
    }

    // INIT
    document.addEventListener('DOMContentLoaded', () => {
      const role = localStorage.getItem('role') || 'manager';
      localStorage.setItem('role', role);
      document.getElementById('role-indicator').textContent = role === 'manager' ? 'Qu·∫£n l√Ω' : role === 'driver' ? 'T√†i x·∫ø' : 'Ph·ª• huynh';

      loadRealData();
      setInterval(tickSimulate, 3000);

      document.getElementById('btn-simulate').addEventListener('click', () => {
        simRunning = !simRunning;
        this.textContent = simRunning ? 'T·∫Øt m√¥ ph·ªèng' : 'B·∫≠t m√¥ ph·ªèng';
      });

      document.getElementById('send-msg').addEventListener('click', () => {
        const to = document.getElementById('msg-to').value;
        const body = document.getElementById('msg-body').value || '‚Äî';
        state.inbox.push(`${new Date().toLocaleString()} ‚Äî G·ª≠i: ${to} ‚Äî ${body}`);
        document.getElementById('inbox').innerHTML = state.inbox.slice().reverse().map(m =>
          `<div style="padding:6px; border-bottom:1px solid #f1f5f9; font-size:13px;">${m}</div>`
        ).join('');
        document.getElementById('msg-body').value = '';
      });

      // Navigation
      document.querySelectorAll('.sidebar li').forEach(li => {
        li.addEventListener('click', () => {
          document.querySelectorAll('.sidebar li').forEach(x => x.classList.remove('active'));
          li.classList.add('active');
          document.querySelectorAll('[id$="-view"]').forEach(v => v.classList.add('hidden'));
          const page = li.dataset.page + '-view';
          const view = document.getElementById(page);
          if (view) view.classList.remove('hidden');
          document.getElementById('page-title').textContent = li.textContent;
        });
      });

      // Default page
      document.querySelector('.sidebar li').click();
    });

    window.logout = () => {
      localStorage.removeItem('role');
      alert('ƒê√£ ƒëƒÉng xu·∫•t!');
      location.reload();
    };
  </script>
</body>
</html>


