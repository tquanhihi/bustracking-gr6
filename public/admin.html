<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Admin - SSB 1.0</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background:#f1f5f9; margin:0; display:flex; }
    .sidebar { width:260px; background:#1e293b; color:white; padding:20px; height:100vh; position:fixed; }
    .sidebar-brand { font-size:22px; font-weight:bold; margin-bottom:30px; }
    nav button { width:100%; text-align:left; padding:12px 16px; margin:6px 0; border:none; background:#334155; color:white; border-radius:8px; cursor:pointer; transition:0.2s; }
    nav button:hover, nav button.active { background:#475569; }
    .main-content { margin-left:260px; padding:24px; width:100%; }
    .card { background:white; border-radius:12px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-bottom:24px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:12px; text-align:left; border-bottom:1px solid #e2e8f0; }
    th { background:#f8fafc; font-weight:600; }
    .btn { background:#059669; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; }
    .btn.danger { background:#dc2626; }
    .btn.ghost { background:transparent; color:#059669; border:1px solid #059669; }
    .hidden { display:none; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:998; }
    .modal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:24px; border-radius:12px; z-index:999; width:90%; max-width:500px; }
    .chip { background:#e0e7ff; color:#4338ca; padding:4px 12px; border-radius:20px; font-size:13px; }
    .muted { color:#64748b; font-size:13px; }
  </style>
</head>
<body class="admin-page">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-brand">SSB Admin</div>
    <nav>
      <button class="btn active" data-view="dashboard">Dashboard</button>
      <button class="btn" data-view="parents">Phụ huynh</button>
      <button class="btn" data-view="drivers">Tài xế</button>
      <button class="btn" data-view="buses">Xe buýt</button>
      <button class="btn" data-view="students">Học sinh</button>
      <button class="btn" data-view="routes">Tuyến</button>
      <button class="btn" data-view="messages">Tin nhắn</button>
      <button class="btn" data-view="logs">Logs</button>
      <div style="margin-top:auto;padding-top:20px">
        <button id="logoutBtn" class="btn ghost">Đăng xuất</button>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h2 id="view-title">Dashboard</h2>
        <div class="muted">Quản trị hệ thống SSB</div>
      </div>
      <div class="chip">Role: <span id="role-indicator">Admin</span></div>
    </header>

    <!-- Dashboard -->
    <section id="view-dashboard" class="view card">
      <h3>Hệ thống</h3>
      <div class="grid">
        <div class="card"><h4>Health</h4><div id="health-status">Đang kiểm tra...</div></div>
        <div class="card"><h4>Realtime</h4><div id="realtime-badges">Kết nối Socket.IO</div></div>
      </div>
        <!-- Google Map container -->
        <div class="card" style="margin-top:16px">
          <h4>Bản đồ vị trí xe</h4>
          <div id="map" style="height:420px;width:100%;border-radius:6px;background:#f5f7fb">Đang tải bản đồ...</div>
        </div>
      <h3 style="margin-top:24px">Thống kê</h3>
      <div class="grid">
        <div class="card" style="text-align:center"><h1 style="color:#2563eb" id="stat-parents">0</h1><p>Phụ huynh</p></div>
        <div class="card" style="text-align:center"><h1 style="color:#dc2626" id="stat-drivers">0</h1><p>Tài xế</p></div>
        <div class="card" style="text-align:center"><h1 style="color:#16a34a" id="stat-buses">0</h1><p>Xe buýt</p></div>
        <div class="card" style="text-align:center"><h1 style="color:#ea580c" id="stat-students">0</h1><p>Học sinh</p></div>
      </div>
    </section>

    <!-- Phụ huynh -->
    <section id="view-parents" class="view card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Phụ huynh</h3>
        <button class="btn" onclick="openAddModal()">Thêm phụ huynh</button>
      </div>
      <input type="text" placeholder="Tìm kiếm..." style="width:100%;padding:10px;margin:12px 0;border:1px solid #ccc;border-radius:6px">
      <div class="muted">Tổng: <strong id="parents-count">0</strong></div>
      <table class="table">
        <thead><tr><th>ID</th><th>Họ tên</th><th>SĐT</th><th>Email</th><th>Hành động</th></tr></thead>
        <tbody id="parents-table-body"></tbody>
      </table>
    </section>

    <!-- Modal -->
    <div id="modal-backdrop" class="modal-backdrop hidden"></div>
    <div id="modal" class="modal hidden">
      <div class="modal-header">
        <h3 id="modal-title">Thêm phụ huynh</h3>
        <button onclick="closeModal()" class="btn ghost">✕</button>
      </div>
      <div>
        <input id="input-name" placeholder="Họ tên" />
        <input id="input-phone" placeholder="SĐT" />
        <input id="input-email" placeholder="Email" />
      </div>
      <div style="text-align:right;margin-top:16px">
        <button class="btn" onclick="saveParent()">Lưu</button>
        <button class="btn ghost" onclick="closeModal()">Hủy</button>
      </div>
    </div>

  </main>

  <script>
    const socket = io();
    let state = { buses: [], parents: [] };
    let editingId = null;

    // === CHUYỂN TAB ===
    document.querySelectorAll('nav button').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-${btn.dataset.view}`).classList.remove('hidden');
        document.getElementById('view-title').textContent = btn.textContent;
        if (btn.dataset.view === 'parents') loadParents();
      };
    });

    // === LOAD PHỤ HUYNH ===
    async function loadParents() {
      try {
        const res = await fetch('/api/parents/list');
        const json = await res.json();
        if (json.success) {
          document.getElementById('parents-count').textContent = json.count;
          document.getElementById('parents-table-body').innerHTML = json.data.map(p => `
            <tr>
              <td>${p.id}</td>
              <td>${p.full_name}</td>
              <td>${p.phone||'-'}</td>
              <td>${p.email||'-'}</td>
              <td>
                <button class="btn small" onclick="editParent(${p.id},'${p.full_name}','${p.phone||''}','${p.email||''}')">Sửa</button>
                <button class="btn danger small" onclick="deleteParent(${p.id})">Xóa</button>
              </td>
            </tr>
          `).join('');
        }
      } catch (err) { console.error(err); }
    }

    // === MODAL ===
    function openAddModal() {
      editingId = null;
      document.getElementById('modal-title').textContent = 'Thêm phụ huynh';
      document.getElementById('input-name').value = '';
      document.getElementById('input-phone').value = '';
      document.getElementById('input-email').value = '';
      document.getElementById('modal-backdrop').classList.remove('hidden');
      document.getElementById('modal').classList.remove('hidden');
    }
    function editParent(id, name, phone, email) {
      editingId = id;
      document.getElementById('modal-title').textContent = 'Sửa phụ huynh';
      document.getElementById('input-name').value = name;
      document.getElementById('input-phone').value = phone;
      document.getElementById('input-email').value = email;
      document.getElementById('modal-backdrop').classList.remove('hidden');
      document.getElementById('modal').classList.remove('hidden');
    }
    function closeModal() {
      document.getElementById('modal-backdrop').classList.add('hidden');
      document.getElementById('modal').classList.add('hidden');
    }

    // === CRUD ===
    async function saveParent() {
      const data = {
        full_name: document.getElementById('input-name').value,
        phone: document.getElementById('input-phone').value,
        email: document.getElementById('input-email').value
      };
      const url = editingId ? `/api/parents/${editingId}` : '/api/parents';
      const method = editingId ? 'PUT' : 'POST';
      await fetch(url, { method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
      closeModal();
      loadParents();
    }
    async function deleteParent(id) {
      if (confirm('Xóa phụ huynh này?')) {
        await fetch(`/api/parents/${id}`, { method:'DELETE' });
        loadParents();
      }
    }

    // === REALTIME ===
    socket.on('parentAdded', loadParents);
    socket.on('parentUpdated', loadParents);
    socket.on('parentDeleted', loadParents);

    // === KHỞI ĐỘNG ===
    document.addEventListener('DOMContentLoaded', () => {
      loadParents();
      document.querySelector('nav button').click(); // Mở Dashboard
    });

    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('role');
      location.href = 'login.html';
    };
  </script>
</body>
</html>